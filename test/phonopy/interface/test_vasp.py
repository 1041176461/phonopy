import unittest

import numpy as np
try:
    from StringIO import StringIO
except ImportError:
    from io import StringIO
import tarfile
from phonopy.interface.vasp import Vasprun

force_data = [
    """    -0.01806194      0.00000000      0.00000000
     0.00302404      0.00000000      0.00000000
    -0.00004340      0.00000000      0.00000000
     0.00010669      0.00000000      0.00000000
    -0.00004340      0.00000000      0.00000000
     0.00010669      0.00000000      0.00000000
    -0.00015899      0.00000000      0.00000000
     0.00013442      0.00000000      0.00000000
    -0.00057168     -0.00000212     -0.00000212
     0.00038176      0.00000024      0.00000024
    -0.00057168      0.00000212     -0.00000212
     0.00038176     -0.00000024      0.00000024
    -0.00057168     -0.00000212      0.00000212
     0.00038176      0.00000024     -0.00000024
    -0.00057168      0.00000212      0.00000212
     0.00038176     -0.00000024     -0.00000024
     0.00048457      0.00000000      0.00193549
     0.00048501      0.00000000     -0.00192143
    -0.00001838      0.00000000     -0.00001788
    -0.00001737      0.00000000      0.00001704
     0.00048457      0.00000000     -0.00193549
     0.00048501      0.00000000      0.00192143
    -0.00001838      0.00000000      0.00001788
    -0.00001737      0.00000000     -0.00001704
     0.00048457      0.00193549      0.00000000
     0.00048501     -0.00192143      0.00000000
     0.00048457     -0.00193549      0.00000000
     0.00048501      0.00192143      0.00000000
    -0.00001838     -0.00001788      0.00000000
    -0.00001737      0.00001704      0.00000000
    -0.00001838      0.00001788      0.00000000
    -0.00001737     -0.00001704      0.00000000
    -0.00008108     -0.00042820     -0.00042820
    -0.00008351      0.00042588      0.00042588
    -0.00008108      0.00042820     -0.00042820
    -0.00008351     -0.00042588      0.00042588
    -0.00008108     -0.00042820      0.00042820
    -0.00008351      0.00042588     -0.00042588
    -0.00008108      0.00042820      0.00042820
    -0.00008351     -0.00042588     -0.00042588
     0.00502017      0.00000000      0.00000000
     0.00461404      0.00000000      0.00000000
     0.00004083      0.00000000      0.00000000
     0.00003737      0.00000000      0.00000000
     0.00004083      0.00000000      0.00000000
     0.00003737      0.00000000      0.00000000
    -0.00001053      0.00000000      0.00000000
    -0.00001180      0.00000000      0.00000000
     0.00171488     -0.00001102      0.00000000
    -0.00096003     -0.00000136      0.00000000
     0.00171488      0.00001102      0.00000000
    -0.00096003      0.00000136      0.00000000
     0.00019361      0.00000118      0.00000000
    -0.00023590      0.00000009      0.00000000
     0.00019361     -0.00000118      0.00000000
    -0.00023590     -0.00000009      0.00000000
     0.00171488      0.00000000     -0.00001102
    -0.00096003      0.00000000     -0.00000136
     0.00019361      0.00000000      0.00000118
    -0.00023590      0.00000000      0.00000009
     0.00171488      0.00000000      0.00001102
    -0.00096003      0.00000000      0.00000136
     0.00019361      0.00000000     -0.00000118
    -0.00023590      0.00000000     -0.00000009""",
    """    -0.00007218     -0.00042473     -0.00042473
    -0.00006676      0.00042723      0.00042723
    -0.00007218      0.00042473     -0.00042473
    -0.00006676     -0.00042723      0.00042723
    -0.00007218     -0.00042473      0.00042473
    -0.00006676      0.00042723     -0.00042723
    -0.00007218      0.00042473      0.00042473
    -0.00006676     -0.00042723     -0.00042723
     0.00463451      0.00000000      0.00000000
     0.00503148      0.00000000      0.00000000
     0.00004993      0.00000000      0.00000000
     0.00005109      0.00000000      0.00000000
     0.00004993      0.00000000      0.00000000
     0.00005109      0.00000000      0.00000000
    -0.00000304      0.00000000      0.00000000
     0.00000120      0.00000000      0.00000000
     0.00172341      0.00000778      0.00000000
    -0.00094457     -0.00000047      0.00000000
     0.00172341     -0.00000778      0.00000000
    -0.00094457      0.00000047      0.00000000
     0.00020424      0.00000195      0.00000000
    -0.00022024     -0.00000155      0.00000000
     0.00020424     -0.00000195      0.00000000
    -0.00022024      0.00000155      0.00000000
     0.00172341      0.00000000      0.00000778
    -0.00094457      0.00000000     -0.00000047
     0.00020424      0.00000000      0.00000195
    -0.00022024      0.00000000     -0.00000155
     0.00172341      0.00000000     -0.00000778
    -0.00094457      0.00000000      0.00000047
     0.00020424      0.00000000     -0.00000195
    -0.00022024      0.00000000      0.00000155
    -0.02367317      0.00000000      0.00000000
     0.00132016      0.00000000      0.00000000
    -0.00051598      0.00000000      0.00000000
     0.00064635      0.00000000      0.00000000
    -0.00051598      0.00000000      0.00000000
     0.00064635      0.00000000      0.00000000
    -0.00016915      0.00000000      0.00000000
     0.00017427      0.00000000      0.00000000
    -0.00080160      0.00000398      0.00000398
     0.00051705     -0.00000107     -0.00000107
    -0.00080160     -0.00000398      0.00000398
     0.00051705      0.00000107     -0.00000107
    -0.00080160      0.00000398     -0.00000398
     0.00051705     -0.00000107      0.00000107
    -0.00080160     -0.00000398     -0.00000398
     0.00051705      0.00000107      0.00000107
     0.00136747      0.00000000      0.00205067
     0.00137437      0.00000000     -0.00206950
    -0.00001461      0.00000000      0.00019259
    -0.00001133      0.00000000     -0.00018984
     0.00136747      0.00000000     -0.00205067
     0.00137437      0.00000000      0.00206950
    -0.00001461      0.00000000     -0.00019259
    -0.00001133      0.00000000      0.00018984
     0.00136747      0.00205067      0.00000000
     0.00137437     -0.00206950      0.00000000
     0.00136747     -0.00205067      0.00000000
     0.00137437      0.00206950      0.00000000
    -0.00001461      0.00019259      0.00000000
    -0.00001133     -0.00018984      0.00000000
    -0.00001461     -0.00019259      0.00000000
    -0.00001133      0.00018984      0.00000000"""]

class TestVASP(unittest.TestCase):

    def setUp(self):
        self._tar = tarfile.open("vasprun.xml.tar.bz2")
    
    def tearDown(self):
        pass
    
    def test_parse_vasprun_xml(self):
        for i, member in enumerate(self._tar.getmembers()):
            vr = Vasprun(self._tar.extractfile(member), use_expat=True)
            # for force in vr.read_forces():
            #     print("% 15.8f % 15.8f % 15.8f" % tuple(force))
            # print("")
            ref = np.loadtxt(StringIO(force_data[i]))
            np.testing.assert_allclose(ref, vr.read_forces(), atol=1e-8)

if __name__ == '__main__':
    suite = unittest.TestLoader().loadTestsFromTestCase(TestVASP)
    unittest.TextTestRunner(verbosity=2).run(suite)
    # unittest.main()
